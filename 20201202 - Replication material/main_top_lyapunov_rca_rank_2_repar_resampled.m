clc;
clear;

addpath('Library/DERIVESTsuite')
Data = readtable('residuals_rr2.xlsx');
res   = table2array(Data(1:end,2:4))';  
res   =  res-mean(res')';           %Center to mean zero
res   =  inv(chol(cov(res')))*res;  %Standardize to be D(0,I_3)

p   = 3;
T   = 10^8;

%Estimates from reparamized estimation (using fminunc)
theta_hat = [-1.29250675762956;-0.197703773756927;0.0999912124561209;-2.22278135200156;-2.35948585292302;-3.25797954714723;-0.353846346305767;0.282570272671724;0.345271090851654;0.402888912754769;-0.0801474444957173;0.266877253542641;1.06413624277508;0.135450054287600;0.000173426102460370;0.00204023586757169;-0.277689619782380;2.55346326705822e-05;-0.164082562938887;0.954329782147865];
V_hat = [183.303481765772,-93.7235139124637,81.4048349761194,-19.7769651306550,2.28308783746116,-34.5312750408884,-3.70395173821924,0.176301210088145,1.61258226248342,-13.5469491406598,-0.0873401921036292,-2.47982436205323,-23.3625047915388,9.21935706060495,275.386834585675,0.0587447406490185,-13.4566937503460,-0.0853205820990946,1.50645124769582,1.02083197055007;-93.7235139124639,51.0356537768097,-41.6347986262322,9.89483363125414,-4.00601673965532,16.5419556889942,2.08983315233379,-0.248069904554042,-0.474276766891135,4.85227549543626,0.102610989588022,1.05838951726332,10.2339666244133,-3.96994218826072,-132.726433479046,-0.0375941748975557,2.87204203584107,0.0410154931694577,-0.398064513293527,-0.412771227034397;81.4048349761194,-41.6347986262322,37.1104586968151,-8.97195751456733,-2.13205334205550,-9.25535644638975,-2.22775814264562,-0.0190526712340852,0.578956375843815,-4.50472475853228,-0.0453762742531021,-1.18912586322374,-11.3143086955493,4.14486809384194,127.610658642890,0.0241064099481533,-5.13363752734288,-0.0397391456348455,0.436693173601017,0.415003146430261;-19.7769651306550,9.89483363125421,-8.97195751456739,345.972617075277,116.637397733797,-63.5437252217083,-22.6291741057447,4.03517948381540,-11.5860674706091,24.6789175240788,-3.17122421057181,4.97334545175073,-29.5069565425776,-1.95191267853033,414.746756949386,-0.277318207516731,165.773340628855,-0.240266625141670,-12.9980242868256,-1.72194682998407;2.28308783746109,-4.00601673965530,-2.13205334205553,116.637397733797,197.820923000842,-128.571010015527,-7.62842988744903,5.27438940992902,-12.2586302960961,0.698278597474442,-1.76223553255011,-1.31012423259922,-4.62391536529710,6.26325271017432,-39.2438404827367,-0.0513961752602564,126.476683514638,-0.0813919297048662,-6.53214215291595,0.506739094293426;-34.5312750408884,16.5419556889943,-9.25535644638982,-63.5437252217081,-128.571010015526,1535.75889545830,-1.05257900536133,19.4726410481778,-2.78847005964639,49.7009502267226,-0.105210277110330,29.2861114596098,11.5051044552021,-5.25129589529175,-136.428301315655,-0.200940801823912,20.0968547157880,-0.467685606483462,-8.00018114097930,-13.3874187254183;-3.70395173821926,2.08983315233381,-2.22775814264563,-22.6291741057448,-7.62842988744908,-1.05257900536152,17.2643580710765,-2.08972929676691,-1.11566654250210,-3.23672761119703,0.166683176774757,-0.504299710370039,28.8962840120979,-9.36335829827395,-143.662982862683,0.0782952118186232,-29.9492084226433,0.0555064862713407,1.63030658583910,0.234280000842797;0.176301210088071,-0.248069904553996,-0.0190526712341180,4.03517948381553,5.27438940992913,19.4726410481778,-2.08972929676691,42.8777672439230,-1.41281171727744,3.25570583178997,-0.196250362225775,2.25241899505334,-0.123772420884269,-0.157935180522573,36.0339617472819,-0.0253315826475927,21.8514152675278,-0.0235146591169442,-2.26053810146578,-1.79740911806282;1.61258226248343,-0.474276766891146,0.578956375843822,-11.5860674706091,-12.2586302960961,-2.78847005964635,-1.11566654250211,-1.41281171727741,14.4024857138993,-7.53740270591249,0.463081682343809,0.541905716443283,-11.3492418105844,3.84228678540094,41.2361405908564,-0.0150180423209050,-20.1128522375561,-0.000800326089975888,2.90857433561060,0.160916091593091;-13.5469491406598,4.85227549543628,-4.50472475853230,24.6789175240788,0.698278597474499,49.7009502267224,-3.23672761119701,3.25570583178988,-7.53740270591248,62.5725835989545,-0.571438542625739,3.51377474813850,6.83822476886100,-3.79270725402666,16.8136133596545,0.0582043752096456,61.5300834642609,-0.00211999274150826,-7.34816107166068,-2.73090915913348;-0.0873401921036307,0.102610989588022,-0.0453762742531023,-3.17122421057181,-1.76223553255011,-0.105210277110348,0.166683176774757,-0.196250362225775,0.463081682343810,-0.571438542625738,0.397647194927472,-0.0815982182966427,0.632611663538454,-0.0826985841641028,-6.45172111972003,0.00377340400583303,-3.93357494248514,0.00478669220583851,0.328863218072730,0.0368842193618522;-2.47982436205325,1.05838951726333,-1.18912586322374,4.97334545175078,-1.31012423259918,29.2861114596097,-0.504299710370035,2.25241899505337,0.541905716443281,3.51377474813851,-0.0815982182966428,2.92951045262199,1.20054768901731,-0.782923339261915,20.3060478834480,-0.0188996489770552,1.67900356720029,-0.000291283831560523,-0.101533964119004,-0.896584505246115;-23.3625047915387,10.2339666244133,-11.3143086955492,-29.5069565425775,-4.62391536529727,11.5051044552019,28.8962840120979,-0.123772420884366,-11.3492418105844,6.83822476886101,0.632611663538455,1.20054768901731,93.4295197778884,-32.1807062567546,-256.781688017514,-0.0939752974146870,-31.3733912077879,0.0904048864019073,0.337042716515703,-0.500729557836794;9.21935706060493,-3.96994218826071,4.14486809384194,-1.95191267853035,6.26325271017440,-5.25129589529170,-9.36335829827393,-0.157935180522581,3.84228678540092,-3.79270725402670,-0.0826985841641017,-0.782923339261921,-32.1807062567545,12.7390334161798,59.4902779863481,0.0478344966586870,8.27458834292670,-0.0239885072047814,0.459803354744536,0.295305746188445;275.386834585677,-132.726433479046,127.610658642890,414.746756949384,-39.2438404827369,-136.428301315657,-143.662982862683,36.0339617472836,41.2361405908566,16.8136133596550,-6.45172111971999,20.3060478834483,-256.781688017514,59.4902779863482,13547.0903786681,-4.13471604591960,33.1514730959155,-3.23293927363362,-17.2980590374195,-3.35338610118853;0.0587447406490177,-0.0375941748975551,0.0241064099481529,-0.277318207516713,-0.0513961752602471,-0.200940801823863,0.0782952118186220,-0.0253315826475847,-0.0150180423209062,0.0582043752096507,0.00377340400583296,-0.0188996489770519,-0.0939752974146993,0.0478344966586923,-4.13471604591952,0.00902802148062350,-0.0249346115575259,0.00318942175154639,-0.0120521422627182,-0.00115787470259947;-13.4566937503459,2.87204203584110,-5.13363752734290,165.773340628855,126.476683514638,20.0968547157879,-29.9492084226432,21.8514152675275,-20.1128522375561,61.5300834642608,-3.93357494248515,1.67900356720024,-31.3733912077880,8.27458834292673,33.1514730959155,-0.0249346115575438,268.641868823360,-0.217376495776940,-24.3622281192988,-2.68936651255625;-0.0853205820990946,0.0410154931694578,-0.0397391456348455,-0.240266625141670,-0.0813919297048660,-0.467685606483461,0.0555064862713406,-0.0235146591169439,-0.000800326089975850,-0.00211999274150821,0.00478669220583852,-0.000291283831560499,0.0904048864019073,-0.0239885072047814,-3.23293927363363,0.00318942175154642,-0.217376495776939,0.00277230760138380,0.0158736322184263,-0.00146114519262535;1.50645124769580,-0.398064513293527,0.436693173601017,-12.9980242868255,-6.53214215291594,-8.00018114097925,1.63030658583910,-2.26053810146574,2.90857433561061,-7.34816107166068,0.328863218072730,-0.101533964118996,0.337042716515713,0.459803354744539,-17.2980590374197,-0.0120521422627167,-24.3622281192988,0.0158736322184263,2.73411293500310,0.321705363100075;1.02083197055007,-0.412771227034399,0.415003146430263,-1.72194682998408,0.506739094293413,-13.3874187254183,0.234280000842794,-1.79740911806282,0.160916091593090,-2.73090915913350,0.0368842193618523,-0.896584505246115,-0.500729557836791,0.295305746188441,-3.35338610118854,-0.00115787470259850,-2.68936651255626,-0.00146114519262535,0.321705363100076,0.371500354629007];

theta = theta_hat(7:end);
V = V_hat(7:end,7:end)/3021;

tic
%LE_naive = LyapunovNaive(theta,p,T)
LE_qr    = LyapunovQR(theta,p,T,res)
toc

%Delta method for standard errors
tic
A = jacobianest(@(coef) LyapunovQR(coef(),p,T,res), theta);
%A = jacobianest_par(@(coef) LyapunovQR(coef(),p,T,res), theta);
toc
LE_qr_se = sqrt(diag(A*V*A'))

LE_qr./LE_qr_se


%% FUNCTIONS

function LE_QR = LyapunovQR(param, p, T,res)
%This function uses a robust and efficient QR-method to compute the top
%Lyapunov coefficient. Specifically, we follow Dieci and Van Vleck (1995), 
%Section 2.1
%%INPUT PARAMETERS
%param = [vec(A)',vec(B)']'
%p is the dimension of the system
%T is the number of observation
%%OUTPUT
%LE_QR is the top lyapunov coefficient
          
n=2;
tal = 1;
a = vec2mat(param(tal:tal+p*n-1),n).^2;
tal = tal + p*n;
     
g = zeros(p,n);
g(1:p-n,:) = vec2mat(param(tal:tal+(p-n)*n-1),n).^2; %FIRST ROW FREE
g(p-n+1:end,:)=eye(n,n);
tal=tal+(p-n)*n;   

b = reshape(param(tal:tal+p*n-1),n,p)'.^2;
tal=tal+p*n; 

A    = g*a'; 
B    = g*b'; 

%Simulate RCA
rng(10);
%Z = randn(p,T); %Gaussian innovations
Phi = NaN(p,p,T);
Z = NaN(p,T);

%parfor t=1:T
for t=1:T
    Z(:,t) = res(:,randi(3020));
    %res(:,randi(T)); 
    Phi(:,:,t) = A*diag(Z(:,t).^2)+B; %Equation (9) in Hetland et. al.    
    %This variable is called A_i in the Dieci paper
end

% QR algorithm approach
Q = NaN(p,p,T);
Z = NaN(p,p,T);
R = NaN(p,p,T);
Q(:,:,1) = eye(p);                     %Eq. 2.13 in Dieci 

for i=2:T
   Z(:,:,i) = Phi(:,:,i-1)*Q(:,:,i-1); %Eq. 2.14 in Dieci
   [Q(:,:,i),R(:,:,i)] = qr(Z(:,:,i)); %Eq. 2.15 in Dieci
end
psi_QR = [real(1/T*sum(log(R(1,1,2:end))));
          real(1/T*sum(log(R(2,2,2:end))));
          real(1/T*sum(log(R(3,3,2:end))))]; %Eq. 2.16 in Dieci

LE_QR = (psi_QR); %Return only the Top Lyapunov coefficient

end

function LE_naive = LyapunovNaive(param, p, T)
%This function computes the top Lyapunov coefficient directly, and approach
%that does not work very well, as the matrix product tends to zero due to
%numerical issues. Instead, the QR method should be used.

%%INPUT PARAMETERS
%param = [vec(A)',vec(B)']'
%p is the dimension of the system
%T is the number of observation
%%OUTPUT
%LE_naive is the top lyapunov coefficient
    
n=2;
tal = 1;
a = vec2mat(param(tal:tal+p*n-1),n).^2;
tal = tal + p*n;
     
g = zeros(p,n);
g(1:p-n,:) = vec2mat(param(tal:tal+(p-n)*n-1),n).^2; %FIRST ROW FREE
g(p-n+1:end,:)=eye(n,n);
tal=tal+(p-n)*n;   

b = reshape(param(tal:tal+p*n-1),n,p)'.^2;
tal=tal+p*n; 

A    = g*a'; 
B    = g*b'; 
%Simulate RCA
Z = randn(p,T); %Gaussian innovations
Phi = NaN(p,p,T);

%parfor t=1:T
for t=1:T
    Phi(:,:,t) = A*diag(Z(:,t).^2)+B;           %Equation (9)
end

%% Naive direct computation
tmp = NaN(p,p,T);
tmp(:,:,1) = Phi(:,:,1);
 %parfor t=1:T
for t=2:T
     tmp(:,:,t) = Phi(:,:,t)*tmp(:,:,t-1);      %Matrix product of Phi's   
end

LE_naive = 1/T*log(norm(tmp(:,:,end)));        %Top lyapunov coeff., eq. (10)

end



