clc;
clear;

addpath('Library/DERIVESTsuite')
Data = readtable('residuals_rr2.xlsx');
res   = table2array(Data(1:end,2:4))';  
res   =  res-mean(res')';           %Center to mean zero
res   =  inv(chol(cov(res')))*res;  %Standardize to be D(0,I_3)

p   = 3;
T   = 10^8;

%%Theta, contains A and B matrices from unrestricted rank model
%theta = [0.122429641106036;0.138890957455967;0.0807610772816973;0.151960936953301;0.108255722588551;0.168063161803982;0.00998695704406517;0.00550101191460603;0.0713553835818725;4.31541305941314e-09;0.0599986374118052;8.04780695277565e-07;0.126270449154116;8.02054445825689e-08;1.52504457796891e-06;0.0445657878167126;0.0269106201756430;0.910141045353691];
%%Sandwich covariance matrix, contains block of A and B matrix from reduced rank model
%V = [7.70266634769947,1.62409771449145,1.69399304635413,-4.64099530266712,-0.888777688066281,7.22229598400886,0.0739757566823502,0.0314210530501599,0.467684540591864,-1.37236357204226e-06,-16.0590140246505,-4.87968068613217e-05,-18.4059858302265,5.36404183245667e-05,-4.38204841598960e-05,0.708897817244866,1.26381669745499,-0.995115985367668;1.62409771449145,11.4866802157337,0.674436301739334,-1.16182384985105,-1.60874587626244,1.77361672918920,0.0414186176040633,-0.0898218011220163,0.124073236940002,-7.64960593179352e-07,-7.25174812551289,-6.11049782291134e-05,-12.1140129225837,-5.88556014848518e-05,-0.000208543446228195,0.496657088244376,0.444796345857157,-0.232572642430421;1.69399304635413,0.674436301739337,13.5820643309020,-1.18932785142712,-0.318192916548330,1.81637809691413,0.0496003532539753,0.0112936853050392,0.622367331773775,1.53675844171122e-06,-7.17004438373026,-2.22434976861296e-05,-8.64644052676765,8.41016774121507e-06,-2.07687790065383e-05,0.419721104353866,0.632374917040065,-1.89051889118187;-4.64099530266712,-1.16182384985105,-1.18932785142712,17.3948871897688,3.18268710282270,-6.84013305008849,-0.227047836840709,-0.0534344071300714,0.416547553231790,-2.75669975946458e-06,21.6654396466429,-7.44105782499362e-05,22.9981761368027,-9.81895254783121e-05,-0.000115756923253228,-1.52380893666329,-1.83734112447996,0.249925189954329;-0.888777688066283,-1.60874587626244,-0.318192916548332,3.18268710282270,8.70762585546433,-3.86827927648132,-0.0385980055918380,-0.0469565796415540,0.150572411522760,-8.25233970979582e-07,5.84695417048151,-2.72238460599694e-05,5.54706680512131,1.71580732980921e-05,-5.62465502552195e-05,-0.385257144658418,-0.742236362019210,0.225134818921100;7.22229598400885,1.77361672918921,1.81637809691416,-6.84013305008850,-3.86827927648132,46.4264193233947,0.281871925563816,0.0229656317200816,1.73837284598218,-3.96286455510612e-06,-34.7695337826151,5.05168941366597e-05,-38.7304522169604,7.46636162185910e-05,0.000185348041341350,1.92570195837015,3.38054591386405,-4.83680385721364;0.0739757566823502,0.0414186176040633,0.0496003532539751,-0.227047836840709,-0.0385980055918379,0.281871925563816,0.0276100070935596,0.00321698048590079,0.0292761229215799,-2.06196834380814e-07,-0.705557275854833,-5.28257961391696e-07,-0.650946113737039,2.53412135498494e-06,1.17114421038489e-06,0.0229034475803712,0.0569543905382544,-0.0495860336581708;0.0314210530501599,-0.0898218011220162,0.0112936853050391,-0.0534344071300714,-0.0469565796415540,0.0229656317200813,0.00321698048590079,0.0157699735833435,0.00540437207382755,8.16217460968327e-08,-0.188041958251829,-2.57161781553356e-07,-0.408284725025526,2.52392644500391e-07,-3.47755217665155e-07,0.0199879250187417,0.0111745059529479,-0.00528783551382013;0.467684540591864,0.124073236940003,0.622367331773779,0.416547553231789,0.150572411522759,1.73837284598218,0.0292761229215799,0.00540437207382744,0.829453360659172,-2.17236817219202e-06,-0.997371504793267,-1.09184663977541e-05,-0.201337881090534,-1.77018956050820e-06,-2.91500428486516e-06,-0.0909644731311284,0.0834988466653435,-0.917478037413888;-1.37236357204226e-06,-7.64960593179345e-07,1.53675844171116e-06,-2.75669975946459e-06,-8.25233970979588e-07,-3.96286455510609e-06,-2.06196834380813e-07,8.16217460968328e-08,-2.17236817219200e-06,2.82339125898995e-10,-8.91331025605287e-06,1.28245278216359e-09,-3.76057830252412e-05,2.07128035232148e-10,1.34819294024605e-09,7.10933127002539e-07,5.81944381365189e-07,1.89604686694944e-06;-16.0590140246505,-7.25174812551290,-7.17004438373025,21.6654396466429,5.84695417048148,-34.7695337826150,-0.705557275854831,-0.188041958251829,-0.997371504793273,-8.91331025605284e-06,83.2379127047538,-8.69535576173647e-05,97.5359986661542,-0.000197425665358379,-0.000176742126874980,-4.74644777090764,-6.93521382830173,3.85232905203898;-4.87968068613220e-05,-6.11049782291147e-05,-2.22434976861289e-05,-7.44105782499361e-05,-2.72238460599697e-05,5.05168941366574e-05,-5.28257961391690e-07,-2.57161781553341e-07,-1.09184663977543e-05,1.28245278216359e-09,-8.69535576173681e-05,1.85112211003366e-08,-0.000235454875734102,2.44404043499168e-09,2.34916749059459e-08,1.87355720234062e-05,9.32616943087623e-06,-5.90336839757242e-06;-18.4059858302264,-12.1140129225837,-8.64644052676761,22.9981761368027,5.54706680512128,-38.7304522169603,-0.650946113737038,-0.408284725025526,-0.201337881090557,-3.76057830252410e-05,97.5359986661542,-0.000235454875734102,174.744137156355,-0.000290881934317002,-9.68149382431177e-05,-8.72454413684910,-7.69894414887930,3.38756669996455;5.36404183245664e-05,-5.88556014848517e-05,8.41016774121501e-06,-9.81895254783119e-05,1.71580732980922e-05,7.46636162185909e-05,2.53412135498493e-06,2.52392644500393e-07,-1.77018956050820e-06,2.07128035232148e-10,-0.000197425665358378,2.44404043499168e-09,-0.000290881934317003,2.36683393747652e-09,3.51523500343378e-09,1.48734978852090e-05,1.34460879961418e-05,-4.98393396520143e-06;-4.38204841598971e-05,-0.000208543446228194,-2.07687790065335e-05,-0.000115756923253227,-5.62465502552196e-05,0.000185348041341354,1.17114421038493e-06,-3.47755217665140e-07,-2.91500428486645e-06,1.34819294024604e-09,-0.000176742126874983,2.34916749059468e-08,-9.68149382431218e-05,3.51523500343376e-09,3.43268998276869e-08,1.34504026432301e-05,2.43318074762954e-05,-2.64595716686153e-05;0.708897817244866,0.496657088244377,0.419721104353868,-1.52380893666329,-0.385257144658417,1.92570195837014,0.0229034475803713,0.0199879250187417,-0.0909644731311277,7.10933127002538e-07,-4.74644777090766,1.87355720234063e-05,-8.72454413684912,1.48734978852091e-05,1.34504026432304e-05,0.545656769771153,0.385721801968472,-0.102673633260240;1.26381669745499,0.444796345857159,0.632374917040063,-1.83734112447996,-0.742236362019210,3.38054591386405,0.0569543905382544,0.0111745059529479,0.0834988466653429,5.81944381365189e-07,-6.93521382830175,9.32616943087580e-06,-7.69894414887932,1.34460879961419e-05,2.43318074762958e-05,0.385721801968471,0.641952651674587,-0.379246238598244;-0.995115985367669,-0.232572642430422,-1.89051889118189,0.249925189954334,0.225134818921101,-4.83680385721363,-0.0495860336581708,-0.00528783551382014,-0.917478037413887,1.89604686694944e-06,3.85232905203898,-5.90336839757384e-06,3.38756669996456,-4.98393396520144e-06,-2.64595716686157e-05,-0.102673633260241,-0.379246238598245,1.39510090832640];

%Estimates from reparamized estimation (using fminunc)
theta_hat = [-1.35319558333971;-0.160749955208118;0.0744959075733607;-2.25011841849626;-2.36911638065945;-3.25095908674807;0.349899472857614;0.372680771513593;0.284184935001307;0.389821673272923;0.329022373993854;0.409955072909193;0.0999347639416093;0.0741688068840671;0.267124284897260;-6.56918035938514e-05;-0.244946192891021;-0.000897095700177838;-0.355345534872913;-0.000283205657751693;0.00123492695248299;0.211106105588428;0.164044567650511;0.954013126405340];
V_hat = [229.164276181599,-112.048135412633,98.0904660153565,3.67065185125180,24.6358671098360,-47.1699355503746,5.83588942345233,-11.9443119748562,1.16347743727205,-13.7468493001924,2.77280075846814,-12.2007758934475,-2.83662979621753,3.16582223041808,-3.45175103541055,0.103890316231331,-6.09250444447455,-0.0182492299505235,35.8157821828344,-0.107570908936253,-0.0138067308342017,5.76950379275409,-1.65012143695169,1.20465917997345;-112.048135412633,58.1967763508568,-47.8718497703233,-4.73493911568100,-18.0246685663913,21.5513254082074,-5.21768983648838,7.21100266177271,-0.586676949869596,7.93248465950784,-1.66969116555778,2.98729658606287,1.35936504169450,-1.80565079617690,1.43173369096567,-0.0221392181977723,-4.83371816300502,0.0191573391013658,-24.1436241036744,0.0878481149602625,-0.0118292080836919,-3.24588305332974,-0.109124487171275,-0.445248016560385;98.0904660153559,-47.8718497703229,42.9601236671125,0.715855435837911,6.45975678152603,-13.8320059741169,2.29339263577193,-4.21080689277724,0.479597781031389,-5.44918260260628,0.393117968091754,-3.83092392212839,-1.29957903286631,1.34824351133428,-1.56822731224386,0.0380944970756839,-2.75029972456773,-0.00517427245549755,15.4498255341513,-0.0261582355366500,-0.0105228337578341,2.48293236284378,-0.518903398806838,0.477357035485525;3.67065185125177,-4.73493911568097,0.715855435837922,427.979059988697,119.355691490815,-58.4961060481593,27.2771999122271,17.4183129087656,7.07784970964922,-31.0763883671224,-9.38380891943815,38.4477930953702,3.83233154049074,2.96399711383975,5.20969070982150,0.229236003080862,198.509126137632,-0.0393363186697582,245.941771940538,-0.527058075223349,-0.0353263963941162,12.6856525973230,22.7009408860957,-2.25478794240069;24.6358671098360,-18.0246685663912,6.45975678152602,119.355691490815,248.405770771979,-132.974711771918,24.4517067640593,-1.73646022605847,7.46035904825604,-34.9335197140605,-6.18360111675292,8.88602955741278,3.69976265430492,1.90710788163664,-0.889608773664712,-0.0596897711924216,169.275138805199,-0.0707324278162510,139.835850875333,-0.488326116044222,0.0741344389674935,11.3240161436907,14.7158197685331,0.123241599131334;-47.1699355503744,21.5513254082073,-13.8320059741167,-58.4961060481584,-132.974711771918,1540.17832251295,6.32401213837813,0.203290664244051,16.5997931259479,4.31487342479371,-8.20149274362725,59.8338707672526,3.10636161239658,-0.699268746600005,29.0122289308255,0.719498006855705,49.3773648786492,0.379584172300185,-0.362742280644565,0.0540157471125565,-0.172505745313655,1.54653587032049,13.6030757791144,-13.5925361729552;5.83588942345229,-5.21768983648836,2.29339263577193,27.2771999122271,24.4517067640594,6.32401213837816,15.7287611850226,3.11366503508986,4.25899658691647,-8.50632296854528,-1.93003165647788,12.5873914487947,0.528895102701624,0.302688668988087,1.25093966200786,0.0149263876488569,46.8430218920907,0.0388641657080098,37.0087946941108,-0.135327778103197,-0.0253531906858859,2.39927244063065,5.50451368968165,-0.745274175818182;-11.9443119748563,7.21100266177272,-4.21080689277725,17.4183129087656,-1.73646022605848,0.203290664244027,3.11366503508985,20.6757164507547,1.59199943532704,-1.99929706699595,-3.27993349468853,2.90219463151195,0.278023836241330,-0.812387980651929,0.311578701381705,0.00781143638249268,19.8598077652795,0.0456920708358847,22.8686323599826,0.139408386248333,-0.113281319645265,1.57818847208825,1.81887301704156,-0.163533713881003;1.16347743727203,-0.586676949869587,0.479597781031386,7.07784970964927,7.46035904825618,16.5997931259474,4.25899658691648,1.59199943532705,42.0439671808962,-2.68395088913871,-0.850754064708938,3.89770483969235,0.436623529072489,0.133953278145703,2.04961538693606,-0.0205794317521926,25.7507633220934,0.0218123903403539,21.4055037539559,-0.0261241211807130,-0.0147947848143835,1.74903689081414,3.39118700338661,-1.74327390048545;-13.7468493001923,7.93248465950782,-5.44918260260628,-31.0763883671224,-34.9335197140606,4.31487342479375,-8.50632296854528,-1.99929706699595,-2.68395088913871,28.6173663089390,6.20358218303506,-10.7004566496784,-1.45705117343404,-0.462033781102081,1.00005812492931,0.0269123926163353,-56.7245213565608,0.0531948920313836,-41.5065427291338,0.222350066321698,-0.0601145683552054,-4.62917660367357,-7.18293555328033,0.168007901749183;2.77280075846813,-1.66969116555777,0.393117968091755,-9.38380891943818,-6.18360111675297,-8.20149274362720,-1.93003165647788,-3.27993349468853,-0.850754064708943,6.20358218303506,20.1089273787389,-7.16961992162838,-0.293469418033167,-0.481049468648610,0.428298556319846,0.00954510013538564,-18.1373391135914,0.0230581936557972,-11.8611585351090,-0.0460342604593978,-0.0346074180368445,-1.38664242810771,-3.43791353935317,0.179309332627689;-12.2007758934475,2.98729658606286,-3.83092392212838,38.4477930953703,8.88602955741283,59.8338707672526,12.5873914487947,2.90219463151196,3.89770483969242,-10.7004566496784,-7.16961992162836,69.0609691396016,1.72004169708130,0.188825588603395,3.96856319881580,0.0367876280741860,86.5629238791318,-0.0343401043291129,66.4669038468206,-0.160772157198336,0.0915272629906985,5.56278175738370,12.5669164969075,-3.09177491839033;-2.83662979621753,1.35936504169450,-1.29957903286631,3.83233154049074,3.69976265430493,3.10636161239657,0.528895102701625,0.278023836241330,0.436623529072487,-1.45705117343404,-0.293469418033166,1.72004169708130,0.691151643381882,0.108505199906975,0.274172320094283,0.00785225193972167,7.20584637121182,0.00147309479055255,4.58265954265926,-0.0223845774759916,0.00237242517681676,0.271408524358032,0.868537898086469,-0.130025471806974;3.16582223041808,-1.80565079617689,1.34824351133428,2.96399711383975,1.90710788163664,-0.699268746599997,0.302688668988087,-0.812387980651929,0.133953278145702,-0.462033781102081,-0.481049468648610,0.188825588603392,0.108505199906975,0.716685122125975,0.0681946939255402,-0.00418806497963400,2.58763363342010,0.000966243013147263,3.87285275387721,-0.00300395543006476,-0.000949185513545296,0.319143227948614,0.229607036805127,-0.0186828145497689;-3.45175103541056,1.43173369096567,-1.56822731224386,5.20969070982149,-0.889608773664730,29.0122289308254,1.25093966200786,0.311578701381708,2.04961538693607,1.00005812492931,0.428298556319843,3.96856319881580,0.274172320094283,0.0681946939255388,2.90606440265108,0.0309491610969785,3.81077141169560,0.0113906761070295,0.530275139879923,0.00584984671226977,-0.00220914673994526,-0.403271611233436,0.476370939180901,-0.900052749149647;0.103890316231330,-0.0221392181977722,0.0380944970756845,0.229236003080863,-0.0596897711924216,0.719498006855705,0.0149263876488569,0.00781143638249261,-0.0205794317521917,0.0269123926163355,0.00954510013538571,0.0367876280741857,0.00785225193972164,-0.00418806497963400,0.0309491610969783,0.0163564369164577,-0.138483219928061,0.00544040751553387,-0.402747261628295,0.00278333693828288,-0.00415469935232610,-0.0128161263437368,-0.0135004563533172,-0.00756351270556160;-6.09250444447463,-4.83371816300498,-2.75029972456777,198.509126137632,169.275138805199,49.3773648786496,46.8430218920907,19.8598077652795,25.7507633220934,-56.7245213565608,-18.1373391135913,86.5629238791317,7.20584637121181,2.58763363342010,3.81077141169563,-0.138483219928060,346.832512767932,-0.0989276961489382,280.145330064659,-0.711493603463818,0.146072385754735,22.9475976777995,43.1486604450585,-4.12133901647587;-0.0182492299505229,0.0191573391013655,-0.00517427245549741,-0.0393363186697576,-0.0707324278162521,0.379584172300183,0.0388641657080100,0.0456920708358857,0.0218123903403531,0.0531948920313835,0.0230581936557974,-0.0343401043291113,0.00147309479055254,0.000966243013147204,0.0113906761070298,0.00544040751553385,-0.0989276961489421,0.00575039299804282,-0.184653719051449,0.00240495910084226,-0.00530119703572299,-0.0247324646338751,-0.0158431918575721,0.00172443476353081;35.8157821828344,-24.1436241036745,15.4498255341514,245.941771940538,139.835850875333,-0.362742280644602,37.0087946941108,22.8686323599826,21.4055037539558,-41.5065427291338,-11.8611585351090,66.4669038468203,4.58265954265925,3.87285275387721,0.530275139879984,-0.402747261628293,280.145330064659,-0.184653719051449,345.971956081099,-0.722610004943986,0.0551556807938038,29.0757613769705,33.0185853100552,-2.49817380872150;-0.107570908936253,0.0878481149602626,-0.0261582355366502,-0.527058075223349,-0.488326116044224,0.0540157471125580,-0.135327778103197,0.139408386248332,-0.0261241211807128,0.222350066321698,-0.0460342604593980,-0.160772157198335,-0.0223845774759916,-0.00300395543006479,0.00584984671226979,0.00278333693828288,-0.711493603463817,0.00240495910084226,-0.722610004943989,0.00737741044200542,-0.00251276097364008,-0.0621942743928763,-0.0723556050105215,0.00461164653248839;-0.0138067308342022,-0.0118292080836914,-0.0105228337578341,-0.0353263963941081,0.0741344389674915,-0.172505745313679,-0.0253531906858864,-0.113281319645265,-0.0147947848143800,-0.0601145683552049,-0.0346074180368446,0.0915272629907004,0.00237242517681684,-0.000949185513545253,-0.00220914673994624,-0.00415469935232609,0.146072385754737,-0.00530119703572318,0.0551556807938062,-0.00251276097364006,0.00562719613635887,0.0128983224729043,0.0300269525454237,-0.00561470830334457;5.76950379275407,-3.24588305332973,2.48293236284377,12.6856525973231,11.3240161436907,1.54653587032044,2.39927244063065,1.57818847208825,1.74903689081415,-4.62917660367358,-1.38664242810771,5.56278175738368,0.271408524358033,0.319143227948615,-0.403271611233433,-0.0128161263437368,22.9475976777996,-0.0247324646338752,29.0757613769706,-0.0621942743928765,0.0128983224729046,3.06096221172672,2.78452773684313,-0.127451160641647;-1.65012143695167,-0.109124487171280,-0.518903398806838,22.7009408860958,14.7158197685332,13.6030757791144,5.50451368968165,1.81887301704156,3.39118700338660,-7.18293555328034,-3.43791353935317,12.5669164969075,0.868537898086468,0.229607036805128,0.476370939180897,-0.0135004563533172,43.1486604450585,-0.0158431918575713,33.0185853100554,-0.0723556050105221,0.0300269525454243,2.78452773684313,5.96374821060074,-0.605822065376097;1.20465917997345,-0.445248016560385,0.477357035485525,-2.25478794240070,0.123241599131318,-13.5925361729551,-0.745274175818183,-0.163533713881003,-1.74327390048546,0.168007901749186,0.179309332627690,-3.09177491839033,-0.130025471806974,-0.0186828145497689,-0.900052749149647,-0.00756351270556160,-4.12133901647587,0.00172443476353122,-2.49817380872151,0.00461164653248840,-0.00561470830334464,-0.127451160641648,-0.605822065376098,0.383210084702930];

theta = theta_hat(7:end);
V = V_hat(7:end,7:end)/3021;

tic
%LE_naive = LyapunovNaive(theta,p,T)
LE_qr    = LyapunovQR(theta,p,T,res)
toc

%Delta method for standard errors
tic
A = jacobianest(@(coef) LyapunovQR(coef(),p,T,res), theta);
%A = jacobianest_par(@(coef) LyapunovQR(coef(),p,T,res), theta);
toc
LE_qr_se = sqrt(diag(A*V*A'))

LE_qr./LE_qr_se


%% FUNCTIONS

function LE_QR = LyapunovQR(param, p, T,res)
%This function uses a robust and efficient QR-method to compute the top
%Lyapunov coefficient. Specifically, we follow Dieci and Van Vleck (1995), 
%Section 2.1
%%INPUT PARAMETERS
%param = [vec(A)',vec(B)']'
%p is the dimension of the system
%T is the number of observation
%%OUTPUT
%LE_QR is the top lyapunov coefficient
        
n=3;
tal = 1;
a = vec2mat(param(tal:tal+p*n-1),n).^2;
tal = tal + p*n;
     
g = zeros(p,n);
g(1:p-n,:) = vec2mat(param(tal:tal+(p-n)*n-1),n).^2; %FIRST ROW FREE
g(p-n+1:end,:)=eye(n,n);
tal=tal+(p-n)*n;   

b = reshape(param(tal:tal+p*n-1),n,p)'.^2;
tal=tal+p*n; 

A    = g*a'; 
B    = g*b'; 

%Simulate RCA
rng(10);
%Z = randn(p,T); %Gaussian innovations
Phi = NaN(p,p,T);

%parfor t=1:T
for t=1:T
    Z(:,t) = res(:,randi(3020));
    Phi(:,:,t) = A*diag(Z(:,t).^2)+B; %Equation (9) in Hetland et. al.
    %This variable is called A_i in the Dieci paper
end

% QR algorithm approach
Q = NaN(p,p,T);
Z = NaN(p,p,T);
R = NaN(p,p,T);
Q(:,:,1) = eye(p);                     %Eq. 2.13 in Dieci 

for i=2:T
   Z(:,:,i) = Phi(:,:,i-1)*Q(:,:,i-1); %Eq. 2.14 in Dieci
   [Q(:,:,i),R(:,:,i)] = qr(Z(:,:,i)); %Eq. 2.15 in Dieci
end
psi_QR = [real(1/T*sum(log(R(1,1,2:end))));
          real(1/T*sum(log(R(2,2,2:end))));
          real(1/T*sum(log(R(3,3,2:end))))]; %Eq. 2.16 in Dieci

LE_QR = (psi_QR); %Return only the Top Lyapunov coefficient

end

function LE_naive = LyapunovNaive(param, p, T)
%This function computes the top Lyapunov coefficient directly, and approach
%that does not work very well, as the matrix product tends to zero due to
%numerical issues. Instead, the QR method should be used.

%%INPUT PARAMETERS
%param = [vec(A)',vec(B)']'
%p is the dimension of the system
%T is the number of observation
%%OUTPUT
%LE_naive is the top lyapunov coefficient
    
n=3;
tal = 1;
a = vec2mat(param(tal:tal+p*n-1),n).^2;
tal = tal + p*n;
     
g = zeros(p,n);
g(1:p-n,:) = vec2mat(param(tal:tal+(p-n)*n-1),n).^2; %FIRST ROW FREE
g(p-n+1:end,:)=eye(n,n);
tal=tal+(p-n)*n;   

b = reshape(param(tal:tal+p*n-1),n,p)'.^2;
tal=tal+p*n; 

A    = g*a'; 
B    = g*b'; 

%Simulate RCA
Z = randn(p,T); %Gaussian innovations
Phi = NaN(p,p,T);

%parfor t=1:T
for t=1:T
    Phi(:,:,t) = A*diag(Z(:,t).^2)+B;           %Equation (9)
end

%% Naive direct computation
tmp = NaN(p,p,T);
tmp(:,:,1) = Phi(:,:,1);
 %parfor t=1:T
for t=2:T
     tmp(:,:,t) = Phi(:,:,t)*tmp(:,:,t-1);      %Matrix product of Phi's   
end

LE_naive = 1/T*log(norm(tmp(:,:,end)));        %Top lyapunov coeff., eq. (10)

end



